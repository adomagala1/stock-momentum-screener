import streamlit as st
from sqlalchemy import create_engine, text
from pymongo import MongoClient
import logging

from app.database import init_db_if_not_exists
from app.predictive_model import init_predictions_table

logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] %(message)s")


def auto_setup():
    st.header("ğŸ”§ Automatyczna konfiguracja bazy danych")

    st.write("Podaj dane dostÄ™powe do swoich baz danych (Postgres + MongoDB).")

    # Formularz
    pg_url = st.text_input("ğŸ”¹ PostgreSQL URL (np. postgresql://user:pass@host:port/dbname)")
    mongo_uri = st.text_input("ğŸ”¹ Mongo URI (np. mongodb://user:pass@host:27017)")
    mongo_db = st.text_input("ğŸ”¹ Mongo DB name", "stocks_ai")

    if st.button("ğŸš€ Uruchom konfiguracjÄ™"):
        if not pg_url or not mongo_uri:
            st.error("UzupeÅ‚nij wszystkie pola!")
            return

        try:
            # --- PostgreSQL ---
            st.info("ÅÄ…czenie z PostgreSQL...")
            pg_engine = create_engine(pg_url)
            with pg_engine.connect() as conn:
                conn.execute(text("SELECT 1"))
            st.success("âœ… PoÅ‚Ä…czono z PostgreSQL!")

            # Tworzenie tabel, jeÅ›li nie istniejÄ…
            st.info("Tworzenie tabel w Postgres...")
            init_db_if_not_exists()
            init_predictions_table(pg_engine)
            st.success("âœ… Tabele utworzone!")

            # --- MongoDB ---
            st.info("ÅÄ…czenie z MongoDB...")
            mongo_client = MongoClient(mongo_uri)
            db = mongo_client[mongo_db]
            db.create_collection("news", capped=False) if "news" not in db.list_collection_names() else None
            st.success("âœ… Kolekcja news gotowa!")

            # --- Zapis konfiguracji do session_state ---
            st.session_state["pg_url"] = pg_url
            st.session_state["mongo_uri"] = mongo_uri
            st.session_state["mongo_db"] = mongo_db

            st.success("ğŸ¯ Konfiguracja zakoÅ„czona sukcesem! System gotowy do pracy.")
            st.toast("MoÅ¼esz teraz odpaliÄ‡ scraper lub moduÅ‚ predykcyjny.", icon="ğŸ¤–")

        except Exception as e:
            st.error(f"BÅ‚Ä…d konfiguracji: {e}")
            logging.exception(e)
