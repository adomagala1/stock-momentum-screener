# app/web/auth.py

import streamlit as st
from .supabase_client import supabase

def login(email, password):
    # Supabase logowanie
    user = supabase.auth.sign_in_with_password({"email": email, "password": password})
    if user.user:
        # Zapisujemy token do session_state
        st.session_state['user'] = user.user
        st.session_state['access_token'] = user.session.access_token
        st.success(f"Zalogowano: {user.user.email}")
        return True
    else:
        st.error("B≈ÇƒÖd logowania")
        return False

def check_login():
    # Sprawdzamy, czy ju≈º jest token w session_state
    if 'access_token' in st.session_state:
        user = supabase.auth.get_user(st.session_state['access_token'])
        if user.user:
            st.session_state['user'] = user.user
            return True
    return False


def logout():
    """Wylogowanie u≈ºytkownika"""
    st.session_state.pop('user', None)
    st.session_state.pop('is_guest', None)
    try:
        supabase.auth.sign_out()
    except Exception as e:
        pass
    st.success("üëã Wylogowano")

def register(email: str, password: str):
    """Rejestracja nowego u≈ºytkownika"""
    try:
        res = supabase.auth.sign_up({"email": email, "password": password})
        st.success(f"üéâ Utworzono konto dla {email}")
        st.info("Mail -> potwierdzic -> Mozesz sie zalogowac")
    except Exception as e:
        # Lepsza obs≈Çuga b≈Çƒôd√≥w, np. gdy u≈ºytkownik ju≈º istnieje
        if 'User already registered' in str(e):
            st.error("‚ö†Ô∏è U≈ºytkownik z tym adresem email ju≈º istnieje.")
        else:
            st.error(f"‚ö†Ô∏è B≈ÇƒÖd rejestracji: {e}")


